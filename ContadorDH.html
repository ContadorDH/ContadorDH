<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Asistencia C√©lula</title>
<style>
  :root{
    --primary:#0066ff;
    --primary-dark:#004ecc;
    --bg:#f4f6fb;
    --card:#ffffff;
    --muted:#7b7b7b;
    --radius:14px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Inter, Poppins, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:var(--bg);
    color:#222;
    height:100vh;
    overflow:hidden;
  }

  header{
    height:64px;
    background:var(--primary);
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:0 12px;
    font-weight:600;
  }
  header button{ background:none;border:0;color:#fff;font-size:20px;cursor:pointer }
  header .title{ font-size:1.05rem }

  /* menu overlay + drawer */
  #menuOverlay{
    position:fixed; inset:0; background:rgba(0,0,0,0.32); display:none; z-index:80;
  }
  #menuOverlay.active{ display:block; }

  #menu{
    position:fixed; top:0; left:-260px; width:260px; height:100%; background:var(--card);
    box-shadow:4px 0 24px rgba(0,0,0,0.18); transition:left .28s ease; z-index:90;
    padding-top:28px; display:flex; flex-direction:column;
  }
  #menu.active{ left:0; }
  #menu .item{
    padding:14px 18px; border-bottom:1px solid #f0f0f0; background:transparent; text-align:left;
    font-size:1rem; color:#222; border:0; cursor:pointer;
  }
  #menu .item:hover{ background:var(--primary); color:#fff }

  main{
    height:calc(100vh - 64px); overflow:auto; padding:16px 12px;
    display:flex; flex-direction:column; align-items:center; gap:12px;
  }

  .card{
    width:92%; max-width:440px; background:var(--card);
    border-radius:var(--radius); padding:12px 14px; box-shadow:0 8px 20px rgba(12,30,60,0.06);
    display:flex; align-items:center; justify-content:space-between;
  }
  .label{ font-size:1rem; font-weight:600 }
  .controls{ display:flex; align-items:center; gap:8px }

  .counterBtn{
    width:40px; height:40px; border-radius:10px; border:0; background:var(--primary); color:#fff;
    font-size:20px; display:inline-flex; align-items:center; justify-content:center; cursor:pointer;
  }
  .counterBtn.ghost{ background:transparent; color:var(--muted); border:1px solid #eee; width:36px; height:36px; border-radius:8px; font-size:18px; }

  .value{
    min-width:44px; text-align:center; font-weight:700; font-size:1.05rem;
  }

  .totalCard{
    width:92%; max-width:440px; background:linear-gradient(90deg,#fff #fff);
    border-radius:var(--radius); padding:14px; text-align:center; font-weight:700; box-shadow:0 10px 28px rgba(2,20,80,0.04);
    font-size:1.1rem;
  }

  /* ver pantalla */
  #verPantalla{
    position:fixed; inset:64px 0 0 0; background:var(--bg); z-index:70;
    display:none; flex-direction:column; align-items:center; padding:12px 12px; overflow:auto;
    transform:translateX(12px); opacity:0; transition:all .32s ease;
  }
  #verPantalla.active{ display:flex; transform:translateX(0); opacity:1 }

  #verHeader{
    width:100%; max-width:820px; display:flex; gap:8px; align-items:center; justify-content:space-between;
    background:var(--primary); color:#fff; border-radius:10px; padding:10px;
  }
  #verHeader .left{ display:flex; gap:10px; align-items:center }
  #verHeader select{ padding:8px 10px; border-radius:8px; border:0; font-weight:600 }
  #verHeader button{ background:transparent; border:0; color:#fff; font-size:18px; cursor:pointer; padding:6px 10px; border-radius:8px }

  #listado{
    width:92%; max-width:820px; margin-top:12px; display:flex; flex-direction:column; gap:8px;
  }
  .row{
    background:var(--card); padding:10px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.04);
    font-size:0.95rem;
  }
  .row small{ color:var(--muted); display:block; margin-top:6px; font-size:0.85rem }

  /* spinner */
  .spinner{
    width:36px; height:36px; border-radius:50%; border:4px solid #e6eefc; border-top-color:var(--primary);
    animation:spin .9s linear infinite; margin-left:8px;
  }
  @keyframes spin{ to{ transform:rotate(360deg) } }

  /* responsive tweaks */
  @media (min-width:720px){
    main{ padding:22px }
    .card{ padding:14px 18px }
  }
</style>
</head>
<body>

<header>
  <button aria-label="menu" onclick="toggleMenu()">‚ò∞</button>
  <div class="title">üìã Asistencia C√©lula</div>
  <div style="width:28px"></div>
</header>

<!-- drawer overlay -->
<div id="menuOverlay" onclick="closeMenuIfOpen(event)"></div>

<!-- drawer -->
<nav id="menu" aria-hidden="true">
  <button class="item" onclick="subirAsistencia()">üì§ Subir asistencia</button>
  <button class="item" onclick="abrirVerPantalla()">üëÅÔ∏è Ver asistencia</button>
  <button class="item" onclick="eliminarAsistencia()">üóëÔ∏è Eliminar registros</button>
  <!-- √°rea vac√≠a clickeable dentro del men√∫ para cerrarlo -->
  <div style="flex:1"></div>
  <button class="item" onclick="toggleMenu()">Cerrar</button>
</nav>

<main id="principal">
  <!-- Counters -->
  <div class="card">
    <div class="label">Hermanos</div>
    <div class="controls">
      <button class="counterBtn" onclick="changeCount('hermanos', -1)">‚àí</button>
      <div class="value" id="hermanos">0</div>
      <button class="counterBtn" onclick="changeCount('hermanos', 1)">+</button>
    </div>
  </div>

  <div class="card">
    <div class="label">Hermanas</div>
    <div class="controls">
      <button class="counterBtn" onclick="changeCount('hermanas', -1)">‚àí</button>
      <div class="value" id="hermanas">0</div>
      <button class="counterBtn" onclick="changeCount('hermanas', 1)">+</button>
    </div>
  </div>

  <div class="card">
    <div class="label">Amigos</div>
    <div class="controls">
      <button class="counterBtn" onclick="changeCount('amigos', -1)">‚àí</button>
      <div class="value" id="amigos">0</div>
      <button class="counterBtn" onclick="changeCount('amigos', 1)">+</button>
    </div>
  </div>

  <div class="card">
    <div class="label">Adolescentes</div>
    <div class="controls">
      <button class="counterBtn" onclick="changeCount('adolescentes', -1)">‚àí</button>
      <div class="value" id="adolescentes">0</div>
      <button class="counterBtn" onclick="changeCount('adolescentes', 1)">+</button>
    </div>
  </div>

  <div class="card">
    <div class="label">Ni√±os</div>
    <div class="controls">
      <button class="counterBtn" onclick="changeCount('ni√±os', -1)">‚àí</button>
      <div class="value" id="ni√±os">0</div>
      <button class="counterBtn" onclick="changeCount('ni√±os', 1)">+</button>
    </div>
  </div>

  <div class="totalCard">Total asistencia: <span id="total">0</span></div>
</main>

<!-- pantalla ver asistencia -->
<section id="verPantalla" aria-hidden="true">
  <div id="verHeader">
    <div class="left">
      <button onclick="cerrarVerPantalla()">‚Üê</button>
      <div id="tituloMes" style="font-weight:700; font-size:1rem">Asistencia</div>
    </div>

    <div style="display:flex;align-items:center;gap:8px">
      <select id="selectMes" aria-label="Seleccionar mes" onchange="mesSeleccionado()"></select>
      <button title="Refrescar" onclick="refrescarMes()">‚ü≥</button>
      <div id="loadingIndicator" style="display:none"><div class="spinner"></div></div>
    </div>
  </div>

  <div id="listado"></div>

  }<!-- pantalla login -->
<section id="loginScreen" style="
  position:fixed; inset:0; background:#f4f6fb; display:flex; flex-direction:column;
  align-items:center; justify-content:center; z-index:9999;
">
  <div style="background:#fff; padding:30px 24px; border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,0.1); width:85%; max-width:340px; text-align:center;">
    <h2 style="margin-bottom:20px; color:#0066ff;">Iniciar Sesi√≥n</h2>
    <input id="usuarioInput" type="text" placeholder="Tu nombre completo" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ccc; font-size:1rem;">
    <button onclick="login()" style="margin-top:20px; width:100%; background:#0066ff; color:#fff; border:0; border-radius:8px; padding:10px; font-size:1rem; cursor:pointer;">Entrar</button>
  </div>
</section>

</section>

<script>
/* ======== LOGIN Y SESI√ìN ======== */
let usuarioActivo = null;

function login() {
  const nombre = document.getElementById("usuarioInput").value.trim();
  if (!nombre) return alert("Por favor ingresa tu nombre.");
  localStorage.setItem("usuarioCelula", nombre);
  usuarioActivo = nombre;
  document.getElementById("loginScreen").style.display = "none";
  actualizarHeaderNombre();
}

function actualizarHeaderNombre() {
  const headerTitle = document.querySelector("header .title");
  if (usuarioActivo) headerTitle.textContent = `üìã Asistencia C√©lula ‚Äì ${usuarioActivo}`;
}

(function checkLogin() {
  const stored = localStorage.getItem("usuarioCelula");
  if (stored) {
    usuarioActivo = stored;
    document.getElementById("loginScreen").style.display = "none";
    actualizarHeaderNombre();
  }
})();



  
/* ================= CONFIG ================= */
const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbwuad6LbOg5k2TFzphjhPTm-NwMJwURzhfFPsEb8a5oB9KXuXIhWxe5QzrR2xLnDjYVlA/exec";

/* ================= ESTADO ================= */
const datos = { hermanos:0, hermanas:0, amigos:0, adolescentes:0, ni√±os:0 };
const meses = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
let mesActual = meses[(new Date()).getMonth()];

/* ================ UI / MEN√ö ================ */
function toggleMenu(){
  const menu = document.getElementById('menu');
  const overlay = document.getElementById('menuOverlay');
  menu.classList.toggle('active');
  overlay.classList.toggle('active');
  // set aria
  menu.setAttribute('aria-hidden', !menu.classList.contains('active'));
}
function closeMenuIfOpen(evt){
  // si el overlay est√° activo, cerramos (evento click en overlay)
  const menu = document.getElementById('menu');
  if(menu.classList.contains('active')) toggleMenu();
}
/* cerrar men√∫ si se hace click en area vac√≠a del propio menu - ya incluido con bot√≥n "Cerrar" */

/* ================ CONTADORES ================ */
function changeCount(tipo, delta){
  datos[tipo] = Math.max(0, (datos[tipo] || 0) + delta);
  document.getElementById(tipo).textContent = datos[tipo];
  actualizarTotal();
}
function actualizarTotal(){
  const total = Object.values(datos).reduce((a,b)=>a+b,0);
  document.getElementById('total').textContent = total;
}

/* ================ SUBIR ASISTENCIA ================ */
async function subirAsistencia(){
  // cerrar men√∫ si est√° abierto
  const menu = document.getElementById('menu');
  if(menu.classList.contains('active')) toggleMenu();

  const total = Object.values(datos).reduce((a,b)=>a+b,0);
  if(total === 0) return alert('‚ùó No hay personas registradas.');
 const usuario = usuarioActivo;
if (!usuario) return alert("Debes iniciar sesi√≥n antes de subir asistencia.");


  const fecha = new Date().toLocaleString('es-CO', {
    day:'2-digit', month:'2-digit', year:'numeric',
    hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:true
  });

  const params = new URLSearchParams({
    usuario, fecha,
    hermanos: datos.hermanos, hermanas: datos.hermanas,
    amigos: datos.amigos, adolescentes: datos.adolescentes,
    ni√±os: datos.ni√±os, total
  });

  try{
    const res = await fetch(`${URL_SCRIPT}?${params.toString()}`);
    const text = await res.text();
    // tu Apps Script responde "OK" o "DUPLICADO" etc.
    if(text.includes('OK')) {
      alert('‚úÖ Asistencia registrada.');
      // opcional: resetear contadores? no lo hacemos para no cambiar tu flujo
    } else if(text.includes('DUPLICADO')) {
      alert('‚ö†Ô∏è Ya se envi√≥ recientemente (duplicado prevenido).');
    } else {
      alert('‚ÑπÔ∏è Respuesta del servidor: ' + text);
    }
  }catch(err){
    console.error(err);
    alert('‚ö†Ô∏è Error de conexi√≥n con el servidor.');
  }
}

/* ================ VER ASISTENCIA (select meses) ================ */
function abrirVerPantalla(){
  // cerrar men√∫ si abierto
  const menu = document.getElementById('menu');
  if(menu.classList.contains('active')) toggleMenu();

  // poblar select si no est√°
  const select = document.getElementById('selectMes');
  if(select.options.length === 0){
    meses.forEach((m,i)=>{
      const opt = document.createElement('option');
      opt.value = m;
      opt.text = m;
      select.appendChild(opt);
    });
  }
  // seleccionar mes actual por defecto
  select.value = mesActual;
  document.getElementById('tituloMes').textContent = 'Asistencia de: ' + select.value;

  // mostrar pantalla ver
  const vp = document.getElementById('verPantalla');
  vp.classList.add('active');
  vp.setAttribute('aria-hidden','false');

  // cargar datos del mes seleccionado
  verAsistencia(select.value);
}

function cerrarVerPantalla(){
  const vp = document.getElementById('verPantalla');
  vp.classList.remove('active');
  vp.setAttribute('aria-hidden','true');
  // limpiar listado si deseas (no obligatorio)
  // document.getElementById('listado').innerHTML = '';
}

function mesSeleccionado(){
  const select = document.getElementById('selectMes');
  const mes = select.value;
  mesActual = mes;
  document.getElementById('tituloMes').textContent = 'Asistencia de: ' + mes;
  verAsistencia(mes);
}

function refrescarMes(){
  const select = document.getElementById('selectMes');
  verAsistencia(select.value);
}

/* helper: mostrar loading */
function showLoading(show){
  const el = document.getElementById('loadingIndicator');
  el.style.display = show ? 'block' : 'none';
}

/* fetch listar y mostrar en tarjeta */
async function verAsistencia(mes){
  showLoading(true);
  const listado = document.getElementById('listado');
  listado.innerHTML = ''; // limpiar
  try{
    const res = await fetch(`${URL_SCRIPT}?accion=listar&mes=${encodeURIComponent(mes)}`);
    // el script devuelve JSON o "[]"
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch(e){ data = []; }
    if(!data || data.length <= 1){
      listado.innerHTML = `<div class="row">‚ö†Ô∏è No hay registros en ${mes}.</div>`;
      showLoading(false);
      return;
    }

    // data: array de filas. Saltar encabezado (index 0)
    const filas = data.slice(1).reverse(); // mostramos √∫ltimas primero
    listado.innerHTML = filas.map((r, index) => {
  const usuario = r[0] || '';
  const fecha = r[1] || '';
  const h = r[2] || '0';
  const hm = r[3] || '0';
  const am = r[4] || '0';
  const ad = r[5] || '0';
  const ni = r[6] || '0';
  const tot = r[7] || '0';

  // Solo mostrar bot√≥n eliminar si es del usuario logueado
  const puedeEliminar = usuarioActivo && usuario.toLowerCase() === usuarioActivo.toLowerCase();

  return `<div class="row">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <strong>üë§ ${escapeHTML(usuario)}</strong>
      ${puedeEliminar ? `<button onclick="eliminarRegistro('${fecha}', '${usuario}')" style="background:none;border:0;color:#e00;cursor:pointer;font-size:18px;">üóëÔ∏è</button>` : ""}
    </div>
    <small>üìÖ ${escapeHTML(fecha)}</small>
    <div style="margin-top:8px">üôã‚Äç‚ôÇÔ∏è ${h} &nbsp; üôã‚Äç‚ôÄÔ∏è ${hm} &nbsp; ü§ù ${am} &nbsp; üëß ${ad} &nbsp; üßí ${ni}</div>
    <small>üî¢ Total: <strong>${escapeHTML(tot)}</strong></small>
  </div>`;
}).join('');

  }catch(err){
    console.error(err);
    document.getElementById('listado').innerHTML = `<div class="row">‚ö†Ô∏è Error obteniendo datos. Revisa conexi√≥n.</div>`;
  }finally{
    showLoading(false);
  }
}

/* ================ ELIMINAR ASISTENCIA ================ */
/* ======== ELIMINAR UN REGISTRO ESPEC√çFICO ======== */
async function eliminarRegistro(fecha, usuario) {
  if (!confirm(`¬øEliminar la asistencia de ${usuario} (${fecha})?`)) return;
  try {
    const res = await fetch(`${URL_SCRIPT}?accion=eliminar&usuario=${encodeURIComponent(usuario)}&fecha=${encodeURIComponent(fecha)}`);
    const text = await res.text();
    alert(text.includes("ELIMINADA") ? "üóëÔ∏è Asistencia eliminada." : "‚ö†Ô∏è No se pudo eliminar.");
    // refrescar vista actual
    verAsistencia(document.getElementById("selectMes").value);
  } catch (err) {
    console.error(err);
    alert("‚ö†Ô∏è Error al eliminar registro.");
  }
}


/* seguridad: escape HTML simple */
function escapeHTML(s){ return (s+'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* inicializaci√≥n */
(function init(){
  actualizarTotal();
  // poblar select oculto inicialmente para evitar re-render
  const select = document.getElementById('selectMes');
  meses.forEach(m=>{
    const opt = document.createElement('option'); opt.value = m; opt.text = m; select.appendChild(opt);
  });
  // establecer mes por defecto actual
  select.value = mesActual;
})();
</script>
</body>
</html>

