<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Asistencia Bochica Sur</title>
<style>
  :root{
    --primary:#0066ff;
    --primary-dark:#004ecc;
    --bg:#f4f6fb;
    --card:#ffffff;
    --muted:#7b7b7b;
    --radius:14px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Inter, Poppins, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:var(--bg);
    color:#222;
    height:100vh;
    overflow:hidden;
  }
  header{
    height:64px;
    background:var(--primary);
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:0 12px;
    font-weight:600;
    position:relative;
  }
  header button{ background:none;border:0;color:#fff;font-size:20px;cursor:pointer }
  header .title{ font-size:1.05rem }

  /* üîµ C√≠rculo de usuario */
  #userCircle{
    position:absolute;
    top:10px;
    right:10px;
    width:42px;
    height:42px;
    background:#fff;
    color:#0066ff;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:700;
    font-size:1rem;
    box-shadow:0 2px 6px rgba(0,0,0,0.15);
    cursor:pointer;
  }

  #menuOverlay{
    position:fixed; inset:0; background:rgba(0,0,0,0.32); display:none; z-index:80;
  }
  #menuOverlay.active{ display:block; }

  #menu{
    position:fixed; top:0; left:-260px; width:260px; height:100%; background:var(--card);
    box-shadow:4px 0 24px rgba(0,0,0,0.18); transition:left .28s ease; z-index:90;
    padding-top:28px; display:flex; flex-direction:column;
  }
  #menu.active{ left:0; }
  #menu .item{
    padding:14px 18px; border-bottom:1px solid #f0f0f0; background:transparent; text-align:left;
    font-size:1rem; color:#222; border:0; cursor:pointer;
  }
  #menu .item:hover{ background:var(--primary); color:#fff }

  main{
    height:calc(100vh - 64px); overflow:auto; padding:16px 12px;
    display:flex; flex-direction:column; align-items:center; gap:12px;
  }

  .card{
    width:92%; max-width:440px; background:var(--card);
    border-radius:var(--radius); padding:12px 14px; box-shadow:0 8px 20px rgba(12,30,60,0.06);
    display:flex; justify-content:center; align-items:center; margin-bottom:0.8rem;
  }
  .controls{ display:flex; align-items:center; justify-content:space-between; width:100%; }

  .counterBtn{
    width:40px; height:40px; border-radius:10px; border:0; background:var(--primary); color:#fff;
    font-size:20px; display:inline-flex; align-items:center; justify-content:center; cursor:pointer;
  }
  .value{
    min-width:44px; text-align:center; font-weight:700; font-size:1.05rem;
  }

  .totalCard{
    width:92%; max-width:440px; background:#fff;
    border-radius:var(--radius); padding:14px; text-align:center; font-weight:700; box-shadow:0 10px 28px rgba(2,20,80,0.04);
    font-size:1.1rem;
  }

  #verPantalla{
    position:fixed; inset:64px 0 0 0; background:var(--bg); z-index:70;
    display:none; flex-direction:column; align-items:center; padding:12px 12px; overflow:auto;
    transform:translateX(12px); opacity:0; transition:all .32s ease;
  }
  #verPantalla.active{ display:flex; transform:translateX(0); opacity:1 }

  #verHeader{
    width:100%; max-width:820px; display:flex; gap:8px; align-items:center; justify-content:space-between;
    background:var(--primary); color:#fff; border-radius:10px; padding:10px;
  }

  #listado{
    width:92%; max-width:820px; margin-top:12px; display:flex; flex-direction:column; gap:8px;
  }
  .row{
    background:var(--card); padding:10px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.04);
    font-size:0.95rem;
  }
  .row small{ color:var(--muted); display:block; margin-top:6px; font-size:0.85rem }

  #loginScreen{
    position:fixed; inset:0; background:var(--bg); display:flex; align-items:center; justify-content:center;
    flex-direction:column; z-index:120; gap:16px;
  }
  #loginBox{
    background:var(--card); padding:28px; border-radius:var(--radius);
    box-shadow:0 8px 24px rgba(0,0,0,0.08); text-align:center;
  }
  #loginBox input{
    width:220px; padding:10px; border-radius:8px; border:1px solid #ddd; font-size:1rem;
  }
  #loginBox button{
    margin-top:12px; background:var(--primary); color:#fff; border:0; padding:10px 16px; border-radius:8px; cursor:pointer;
    font-weight:600;
  }
  .spinner{
    width:36px; height:36px; border-radius:50%; border:4px solid #e6eefc; border-top-color:var(--primary);
    animation:spin .9s linear infinite; margin-left:8px;
  }
  @keyframes spin{ to{ transform:rotate(360deg) } }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div id="loginBox">
    <h2>Inicio de sesi√≥n</h2>
    <p>Ingresa tu nombre para registrar asistencias</p>
    <input type="text" id="nombreUsuario" placeholder="Tu nombre completo">
    <br>
    <button onclick="iniciarSesion()">Entrar</button>
  </div>
</div>

<header>
  <button aria-label="menu" onclick="toggleMenu()">‚ò∞</button>
  <div class="title">üìã Asistencia C√©lula</div>

  <!-- üîµ C√≠rculo usuario -->
  <span id="userCircle" title="Perfil"></span>
</header>

<div id="menuOverlay" onclick="closeMenuIfOpen(event)"></div>

<nav id="menu" aria-hidden="true">
  <button class="item" onclick="subirAsistencia()">üì§ Subir asistencia</button>
  <button class="item" onclick="abrirVerPantalla()">üëÅÔ∏è Ver asistencia</button>
  <button class="item" onclick="eliminarAsistencia()">üóëÔ∏è Eliminar registros</button>
  <button class="item" onclick="cerrarSesion()">üîí Cerrar sesi√≥n</button>
  <div style="flex:1"></div>
  <button class="item" onclick="toggleMenu()">Cerrar</button>
</nav>

<main id="principal">
  <div class="card">
    <div class="controls">
      <button class="counterBtn" onclick="changeCount('hermanos', -1)">‚àí</button>
      <div style="flex:1;text-align:center;">
        <div class="label">Hermanos</div>
        <div class="value" id="hermanos">0</div>
      </div>
      <button class="counterBtn" onclick="changeCount('hermanos', 1)">+</button>
    </div>
  </div>

  <div class="card">
    <div class="controls">
      <button class="counterBtn" onclick="changeCount('hermanas', -1)">‚àí</button>
      <div style="flex:1;text-align:center;">
        <div class="label">Hermanas</div>
        <div class="value" id="hermanas">0</div>
      </div>
      <button class="counterBtn" onclick="changeCount('hermanas', 1)">+</button>
    </div>
  </div>

  <div class="card">
    <div class="controls">
      <button class="counterBtn" onclick="changeCount('amigos', -1)">‚àí</button>
      <div style="flex:1;text-align:center;">
        <div class="label">Amigos</div>
        <div class="value" id="amigos">0</div>
      </div>
      <button class="counterBtn" onclick="changeCount('amigos', 1)">+</button>
    </div>
  </div>

  <div class="card">
    <div class="controls">
      <button class="counterBtn" onclick="changeCount('adolescentes', -1)">‚àí</button>
      <div style="flex:1;text-align:center;">
        <div class="label">Adolescentes</div>
        <div class="value" id="adolescentes">0</div>
      </div>
      <button class="counterBtn" onclick="changeCount('adolescentes', 1)">+</button>
    </div>
  </div>

  <div class="card">
    <div class="controls">
      <button class="counterBtn" onclick="changeCount('ni√±os', -1)">‚àí</button>
      <div style="flex:1;text-align:center;">
        <div class="label">Ni√±os</div>
        <div class="value" id="ni√±os">0</div>
      </div>
      <button class="counterBtn" onclick="changeCount('ni√±os', 1)">+</button>
    </div>
  </div>

  <div class="totalCard">Total asistencia: <span id="total">0</span></div>
</main>

<section id="verPantalla" aria-hidden="true">
  <div id="verHeader">
    <div class="left"><button onclick="cerrarVerPantalla()">‚Üê</button><div id="tituloMes" style="font-weight:700; font-size:1rem">Asistencia</div></div>
    <div style="display:flex;align-items:center;gap:8px">
      <select id="selectMes" aria-label="Seleccionar mes" onchange="mesSeleccionado()"></select>
      <button title="Refrescar" onclick="refrescarMes()">‚ü≥</button>
      <div id="loadingIndicator" style="display:none"><div class="spinner"></div></div>
    </div>
  </div>
  <div id="listado"></div>
</section>

<script>
const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbwuad6LbOg5k2TFzphjhPTm-NwMJwURzhfFPsEb8a5oB9KXuXIhWxe5QzrR2xLnDjYVlA/exec";
const datos = { hermanos:0, hermanas:0, amigos:0, adolescentes:0, ni√±os:0 };
const meses = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
let mesActual = meses[(new Date()).getMonth()];
let usuarioGlobal = localStorage.getItem("usuarioCelula") || "";

/* === LOGIN === */
function iniciarSesion(){
  const nombre = document.getElementById("nombreUsuario").value.trim();
  if(!nombre) return alert("‚ö†Ô∏è Ingresa tu nombre para continuar.");
  localStorage.setItem("usuarioCelula", nombre);
  usuarioGlobal = nombre;
  document.getElementById("loginScreen").style.display="none";
  actualizarCirculoUsuario();
}
function cerrarSesion(){
  if(confirm("¬øCerrar sesi√≥n?")){
    localStorage.removeItem("usuarioCelula");
    usuarioGlobal="";
    document.getElementById("loginScreen").style.display="flex";
    document.getElementById("userCircle").textContent="";
  }
}
function actualizarCirculoUsuario(){
  const circle=document.getElementById("userCircle");
  if(usuarioGlobal){
    const partes=usuarioGlobal.trim().split(" ");
    const iniciales=partes.map(p=>p[0].toUpperCase()).join("").slice(0,2);
    circle.textContent=iniciales;
  }else circle.textContent="";
}
if(usuarioGlobal){
  document.getElementById("loginScreen").style.display="none";
  actualizarCirculoUsuario();
}

/* === MEN√ö === */
function toggleMenu(){ const menu=document.getElementById('menu');const overlay=document.getElementById('menuOverlay');menu.classList.toggle('active');overlay.classList.toggle('active');}
function closeMenuIfOpen(evt){ const menu=document.getElementById('menu'); if(menu.classList.contains('active')) toggleMenu(); }

/* === CONTADORES === */
function changeCount(tipo, delta){ datos[tipo]=Math.max(0,(datos[tipo]||0)+delta); document.getElementById(tipo).textContent=datos[tipo]; actualizarTotal(); }
function actualizarTotal(){ const total=Object.values(datos).reduce((a,b)=>a+b,0); document.getElementById('total').textContent=total; }

/* === SUBIR === */
async function subirAsistencia(){
  if(!usuarioGlobal) return alert("‚ö†Ô∏è Debes iniciar sesi√≥n primero.");
  const total=Object.values(datos).reduce((a,b)=>a+b,0);
  if(total===0) return alert('‚ùó No hay personas registradas.');
  const fecha=new Date().toLocaleString('es-CO',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:true});
  const params=new URLSearchParams({usuario:usuarioGlobal,fecha,hermanos:datos.hermanos,hermanas:datos.hermanas,amigos:datos.amigos,adolescentes:datos.adolescentes,ni√±os:datos.ni√±os,total});
  try{
    const res=await fetch(`${URL_SCRIPT}?${params.toString()}`);
    const text=await res.text();
    if(text.includes('OK')) alert('‚úÖ Asistencia registrada.');
    else if(text.includes('DUPLICADO')) alert('‚ö†Ô∏è Ya se envi√≥ recientemente.');
    else alert('‚ÑπÔ∏è Respuesta del servidor: '+text);
  }catch(e){alert('‚ö†Ô∏è Error de conexi√≥n.');}
}

/* === VER === */
async function verAsistencia(mes){
  const listado=document.getElementById('listado');listado.innerHTML='';
  try{
    const res=await fetch(`${URL_SCRIPT}?accion=listar&mes=${encodeURIComponent(mes)}`);
    const text=await res.text();let data;try{data=JSON.parse(text);}catch(e){data=[];}
    if(!data||data.length<=1){listado.innerHTML=`<div class="row">‚ö†Ô∏è No hay registros en ${mes}.</div>`;return;}
    const filas=data.slice(1).reverse();
    listado.innerHTML=filas.map(r=>{
      const [usuario,fecha,h,hm,am,ad,ni,tot]=r;
      const esPropio = usuarioGlobal && usuarioGlobal.toLowerCase()===String(usuario).toLowerCase();
      return `<div class="row">
        <strong>üë§ ${usuario}</strong>
        <small>üìÖ ${fecha}</small>
        <div style="margin-top:8px">üôã‚Äç‚ôÇÔ∏è ${h} üôã‚Äç‚ôÄÔ∏è ${hm} ü§ù ${am} üëß ${ad} üßí ${ni}</div>
        <small>üî¢ Total: <strong>${tot}</strong></small>
        ${esPropio?`<button style="margin-top:8px;background:#ff4444;color:#fff;border:0;padding:6px 10px;border-radius:8px;cursor:pointer" onclick="eliminarRegistro('${usuario}','${fecha}')">üóëÔ∏è Eliminar</button>`:''}
      </div>`;
    }).join('');
  }catch(e){listado.innerHTML=`<div class="row">‚ö†Ô∏è Error obteniendo datos.</div>`;}
}

/* === HELPERS === */
function escapeHTML(s){return (s+'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
(function init(){actualizarTotal();if(usuarioGlobal)actualizarCirculoUsuario();})();
</script>
</body>
</html>
