<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Asistencia Bochica Sur</title>
<style>
  :root{
    --primary:#0066ff;
    --primary-dark:#004ecc;
    --bg:#f4f6fb;
    --card:#ffffff;
    --muted:#7b7b7b;
    --radius:14px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Inter, Poppins, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background:var(--bg);
    color:#222;
    height:100vh;
    overflow:hidden;
  }

  /* === Header moderno y centrado === */
  header {
    position: relative;
    height: 64px;
    background: var(--primary);
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 12px;
    font-weight: 600;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }

  header button {
    background: none;
    border: 0;
    color: #fff;
    font-size: 20px;
    cursor: pointer;
  }

  header .title {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
    letter-spacing: 0.3px;
    white-space: nowrap;
    text-shadow: 0 0 6px rgba(255, 255, 255, 0.4);
    animation: fadeInTitle 0.6s ease-in-out;
  }

  @keyframes fadeInTitle {
    from { opacity: 0; transform: translateX(-50%) translateY(-5px); }
    to { opacity: 1; transform: translateX(-50%) translateY(0); }
  }

  #menuOverlay{
    position:fixed; inset:0; background:rgba(0,0,0,0.32); display:none; z-index:80;
  }
  #menuOverlay.active{ display:block; }

  #menu{
    position:fixed; top:0; left:-260px; width:260px; height:100%; background:var(--card);
    box-shadow:4px 0 24px rgba(0,0,0,0.18); transition:left .28s ease; z-index:90;
    padding-top:28px; display:flex; flex-direction:column;
  }
  #menu.active{ left:0; }
  #menu .item{
    padding:14px 18px; border-bottom:1px solid #f0f0f0; background:transparent; text-align:left;
    font-size:1rem; color:#222; border:0; cursor:pointer;
  }
  #menu .item:hover{ background:var(--primary); color:#fff }

  main{
    height:calc(100vh - 64px); overflow:auto; padding:16px 12px;
    display:flex; flex-direction:column; align-items:center; gap:12px;
  }

  .card{
    width:92%; max-width:440px; background:var(--card);
    border-radius:var(--radius); padding:12px 14px; box-shadow:0 8px 20px rgba(12,30,60,0.06);
    display:flex; flex-direction:column; gap:8px;
  }
  .label{ font-size:1rem; font-weight:600; text-align:center; }
  .controls{ display:flex; align-items:center; gap:8px; justify-content:center; }

  .counterBtn{
    width:40px; height:40px; border-radius:10px; border:0; background:var(--primary); color:#fff;
    font-size:20px; display:inline-flex; align-items:center; justify-content:center; cursor:pointer;
  }
  .counterBtn.ghost{ background:transparent; color:var(--muted); border:1px solid #eee; width:36px; height:36px; border-radius:8px; font-size:18px; }

  .value{
    min-width:44px; text-align:center; font-weight:700; font-size:1.05rem;
  }

  .totalCard{
    width:92%; max-width:440px; background:linear-gradient(90deg,#fff,#fff);
    border-radius:var(--radius); padding:14px; text-align:center; font-weight:700; box-shadow:0 10px 28px rgba(2,20,80,0.04);
    font-size:1.1rem;
  }

  #verPantalla{
    position:fixed; inset:64px 0 0 0; background:var(--bg); z-index:70;
    display:none; flex-direction:column; align-items:center; padding:12px 12px; overflow:auto;
    transform:translateX(12px); opacity:0; transition:all .32s ease;
  }
  #verPantalla.active{ display:flex; transform:translateX(0); opacity:1 }

  #verHeader{
    width:100%; max-width:820px; display:flex; gap:8px; align-items:center; justify-content:space-between;
    background:var(--primary); color:#fff; border-radius:10px; padding:10px;
  }
  #verHeader .left{ display:flex; gap:10px; align-items:center }
  #verHeader select{ padding:8px 10px; border-radius:8px; border:0; font-weight:600 }
  #verHeader button{ background:transparent; border:0; color:#fff; font-size:18px; cursor:pointer; padding:6px 10px; border-radius:8px }

  #listado{
    width:92%; max-width:820px; margin-top:12px; display:flex; flex-direction:column; gap:8px;
  }
  .row{
    background:var(--card); padding:10px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.04);
    font-size:0.95rem;
  }
  .row small{ color:var(--muted); display:block; margin-top:6px; font-size:0.85rem }

  #loginScreen{
    position:fixed; inset:0; background:var(--bg); display:flex; align-items:center; justify-content:center;
    flex-direction:column; z-index:120; gap:16px;
  }
  #loginBox{
    background:var(--card); padding:28px; border-radius:var(--radius);
    box-shadow:0 8px 24px rgba(0,0,0,0.08); text-align:center;
  }
  #loginBox input{
    width:220px; padding:10px; border-radius:8px; border:1px solid #ddd; font-size:1rem;
  }
  #loginBox button{
    margin-top:12px; background:var(--primary); color:#fff; border:0; padding:10px 16px; border-radius:8px; cursor:pointer;
    font-weight:600;
  }

  .spinner{
    width:36px; height:36px; border-radius:50%; border:4px solid #e6eefc; border-top-color:var(--primary);
    animation:spin .9s linear infinite; margin-left:8px;
  }
  @keyframes spin{ to{ transform:rotate(360deg) } }

  @keyframes popupFade {
    from { transform:scale(0.9); opacity:0; }
    to { transform:scale(1); opacity:1; }
  }
</style>
</head>
<body>

<!-- Popup de confirmaci√≥n -->
<div id="popupConfirm" style="position:fixed; inset:0; background:rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; z-index:210;">
  <div style="background:#fff; border-radius:16px; padding:24px 28px; text-align:center; box-shadow:0 6px 26px rgba(0,0,0,0.15); width:80%; max-width:300px; animation:popupFade .3s ease;">
    <h3 id="popupConfirmTitle" style="margin:0 0 10px;font-size:1.1rem;color:#222;">Confirmar</h3>
    <p id="popupConfirmMsg" style="font-size:1rem;color:#444;margin:0 0 18px;"></p>
    <div style="display:flex;gap:10px;justify-content:center;">
      <button id="popupConfirmNo" style="background:#ccc;color:#222;border:0;padding:8px 14px;border-radius:10px;font-weight:600;cursor:pointer;">Cancelar</button>
      <button id="popupConfirmYes" style="background:#0066ff;color:#fff;border:0;padding:8px 14px;border-radius:10px;font-weight:600;cursor:pointer;">Aceptar</button>
    </div>
  </div>
</div>

<!-- Popup de usuario -->
<div id="popupUsuario" style="position:fixed; inset:0; background:rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; z-index:200;">
  <div style="background:#fff; border-radius:16px; padding:22px 28px; text-align:center; box-shadow:0 6px 26px rgba(0,0,0,0.15); width:80%; max-width:300px; animation:popupFade .3s ease;">
    <h3 style="margin:0 0 8px;font-size:1.1rem;color:#222;">Usuario actual</h3>
    <p id="popupNombre" style="font-weight:600;font-size:1.05rem;color:#444;margin:0;"></p>
    <button onclick="cerrarPopupUsuario()" style="margin-top:16px;background:#0066ff;color:#fff;border:0; padding:10px 18px;border-radius:10px;font-weight:600;cursor:pointer;">Cerrar</button>
  </div>
</div>

<!-- LOGIN -->
<div id="loginScreen">
  <div id="loginBox">
    <h2>Inicio de sesi√≥n</h2>
    <p>Ingresa tu nombre para registrar asistencias</p>
    <input type="text" id="nombreUsuario" placeholder="Tu nombre completo">
    <br>
    <button onclick="iniciarSesion()">Entrar</button>
  </div>
</div>

<header>
  <button aria-label="menu" onclick="toggleMenu()">‚ò∞</button>
  <div class="title">üìã Asistencia Bochica Sur</div>
  <div id="userCircle" onclick="mostrarNombreUsuario()" title=""
    style="width:36px;height:36px;border-radius:50%;background:#ffffff33;color:#fff;display:flex;
    align-items:center;justify-content:center;font-weight:700;font-size:0.9rem;text-transform:uppercase;
    border:2px solid #ffffff55;cursor:pointer;transition:transform 0.2s ease, background 0.3s ease;">
  </div>
</header>

<div id="menuOverlay" onclick="closeMenuIfOpen(event)"></div>
<nav id="menu" aria-hidden="true">
  <button class="item" onclick="subirAsistencia()">üì§ Subir asistencia</button>
  <button class="item" onclick="abrirVerPantalla()">üëÅÔ∏è Ver asistencia</button>
  <button class="item" onclick="eliminarAsistencia()">üóëÔ∏è Eliminar registros</button>
  <button class="item" onclick="cerrarSesion()">üîí Cerrar sesi√≥n</button>
  <div style="flex:1"></div>
  <button class="item" onclick="toggleMenu()">Cerrar</button>
</nav>

<main id="principal">
  <div class="card"><div class="label">Hermanos</div><div class="controls"><button class="counterBtn" onclick="changeCount('hermanos', -1)">‚àí</button><div class="value" id="hermanos">0</div><button class="counterBtn" onclick="changeCount('hermanos', 1)">+</button></div></div>
  <div class="card"><div class="label">Hermanas</div><div class="controls"><button class="counterBtn" onclick="changeCount('hermanas', -1)">‚àí</button><div class="value" id="hermanas">0</div><button class="counterBtn" onclick="changeCount('hermanas', 1)">+</button></div></div>
  <div class="card"><div class="label">Amigos</div><div class="controls"><button class="counterBtn" onclick="changeCount('amigos', -1)">‚àí</button><div class="value" id="amigos">0</div><button class="counterBtn" onclick="changeCount('amigos', 1)">+</button></div></div>
  <div class="card"><div class="label">Adolescentes</div><div class="controls"><button class="counterBtn" onclick="changeCount('adolescentes', -1)">‚àí</button><div class="value" id="adolescentes">0</div><button class="counterBtn" onclick="changeCount('adolescentes', 1)">+</button></div></div>
  <div class="card"><div class="label">Ni√±os</div><div class="controls"><button class="counterBtn" onclick="changeCount('ni√±os', -1)">‚àí</button><div class="value" id="ni√±os">0</div><button class="counterBtn" onclick="changeCount('ni√±os', 1)">+</button></div></div>
  <div class="totalCard">Total asistencia: <span id="total">0</span></div>
</main>

<section id="verPantalla" aria-hidden="true">
  <div id="verHeader">
    <div class="left"><button onclick="cerrarVerPantalla()">‚Üê</button><div id="tituloMes" style="font-weight:700; font-size:1rem">Asistencia</div></div>
    <div style="display:flex;align-items:center;gap:8px">
      <select id="selectMes" aria-label="Seleccionar mes" onchange="mesSeleccionado()"></select>
      <button title="Refrescar" onclick="refrescarMes()">‚ü≥</button>
      <div id="loadingIndicator" style="display:none"><div class="spinner"></div></div>
    </div>
  </div>
  <div id="listado"></div>
</section>

<script>
const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbwuad6LbOg5k2TFzphjhPTm-NwMJwURzhfFPsEb8a5oB9KXuXIhWxe5QzrR2xLnDjYVlA/exec";
const datos = { hermanos:0, hermanas:0, amigos:0, adolescentes:0, ni√±os:0 };
const meses = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
let mesActual = meses[(new Date()).getMonth()];
let usuarioGlobal = localStorage.getItem("usuarioCelula") || "";

/* === ALERTA MODERNA === */
function mostrarPopupAlerta(titulo, mensaje, callback){
  mostrarPopupConfirm(titulo, mensaje, callback || null);
}

/* === LOGIN === */
function iniciarSesion(){
  const nombre = document.getElementById("nombreUsuario").value.trim();
  if(!nombre) return mostrarPopupAlerta("‚ö†Ô∏è Atenci√≥n", "Ingresa tu nombre para continuar.");
  localStorage.setItem("usuarioCelula", nombre);
  usuarioGlobal = nombre;
  document.getElementById("loginScreen").style.display="none";
  actualizarUserCircle();
  cerrarMenu();
}

function cerrarSesion(){
  mostrarPopupConfirm("Cerrar sesi√≥n", "¬øDeseas cerrar la sesi√≥n actual?", () => {
    localStorage.removeItem("usuarioCelula");
    usuarioGlobal="";
    document.getElementById("loginScreen").style.display="flex";
    cerrarMenu();
  });
}

function cerrarMenu(){
  const menu=document.getElementById('menu');
  const overlay=document.getElementById('menuOverlay');
  if(menu.classList.contains('active')) { menu.classList.remove('active'); overlay.classList.remove('active'); }
}

if(usuarioGlobal){
  document.getElementById("loginScreen").style.display="none";
  actualizarUserCircle();
}

function actualizarUserCircle(){
  const circle = document.getElementById("userCircle");
  if(!circle) return;
  if(!usuarioGlobal){
    circle.textContent = "";
    circle.style.display = "none";
    return;
  }
  const partes = usuarioGlobal.trim().split(" ");
  const iniciales = partes.length > 1
    ? (partes[0][0] + partes[partes.length-1][0])
    : partes[0][0];
  circle.textContent = iniciales.toUpperCase();
  circle.style.display = "flex";
}

function mostrarNombreUsuario(){
  if(!usuarioGlobal) return;
  document.getElementById("popupNombre").textContent = usuarioGlobal;
  document.getElementById("popupUsuario").style.display = "flex";
}

function cerrarPopupUsuario(){
  document.getElementById("popupUsuario").style.display = "none";
}

/* === MEN√ö === */
function toggleMenu(){ const menu=document.getElementById('menu');const overlay=document.getElementById('menuOverlay');menu.classList.toggle('active');overlay.classList.toggle('active');menu.setAttribute('aria-hidden',!menu.classList.contains('active')); }
function closeMenuIfOpen(evt){ const menu=document.getElementById('menu');const overlay=document.getElementById('menuOverlay');if(evt.target===overlay && menu.classList.contains('active')){ menu.classList.remove('active'); overlay.classList.remove('active'); } }

/* === CONTADORES === */
function changeCount(tipo, delta){
  datos[tipo] = Math.max(0, datos[tipo]+delta);
  document.getElementById(tipo).textContent = datos[tipo];
  actualizarTotal();
}
function actualizarTotal(){
  const total = Object.values(datos).reduce((a,b)=>a+b,0);
  document.getElementById("total").textContent = total;
}

/* === SUBIR ASISTENCIA === */
async function subirAsistencia(){
  if(!usuarioGlobal) return mostrarPopupAlerta("‚ö†Ô∏è Atenci√≥n", "Inicia sesi√≥n antes de registrar asistencia.");
  mostrarPopupConfirm("Subir asistencia", "¬øDeseas registrar esta asistencia?", async ()=>{
    const total = Object.values(datos).reduce((a,b)=>a+b,0);
    if(total===0) return mostrarPopupAlerta("‚ö†Ô∏è Atenci√≥n","No puedes subir asistencia vac√≠a.");
    const fd = new FormData();
    fd.append("accion","registrar");
    fd.append("usuario",usuarioGlobal);
    fd.append("fecha",new Date().toLocaleDateString());
    fd.append("hermanos",datos.hermanos);
    fd.append("hermanas",datos.hermanas);
    fd.append("amigos",datos.amigos);
    fd.append("adolescentes",datos.adolescentes);
    fd.append("ni√±os",datos.ni√±os);
    try{
      const res=await fetch(URL_SCRIPT,{method:"POST",body:fd});
      const json=await res.json();
      if(json.ok) mostrarPopupAlerta("‚úÖ √âxito","Asistencia registrada correctamente.");
      else mostrarPopupAlerta("‚ö†Ô∏è Error",json.msg||"Ocurri√≥ un error.");
    }catch(e){ mostrarPopupAlerta("‚ö†Ô∏è Error","No se pudo conectar con el servidor."); }
  });
}

/* === VER ASISTENCIA === */
function abrirVerPantalla(){
  const sec=document.getElementById("verPantalla");
  sec.classList.add("active");
  llenarMeses();
}
function cerrarVerPantalla(){
  document.getElementById("verPantalla").classList.remove("active");
}
function llenarMeses(){
  const sel=document.getElementById("selectMes");
  sel.innerHTML="";
  meses.forEach(m=>{
    const op=document.createElement("option");
    op.value=m; op.textContent=m;
    if(m===mesActual) op.selected=true;
    sel.appendChild(op);
  });
  cargarMes(mesActual);
}
async function cargarMes(m){
  document.getElementById("tituloMes").textContent=m;
  const loader=document.getElementById("loadingIndicator");
  loader.style.display="block";
  try{
    const res=await fetch(`${URL_SCRIPT}?accion=listar&mes=${m}`);
    const json=await res.json();
    mostrarListado(json);
  }catch(e){
    mostrarPopupAlerta("‚ö†Ô∏è Error","No se pudo cargar la asistencia.");
  }
  loader.style.display="none";
}
function mostrarListado(list){
  const div=document.getElementById("listado");
  div.innerHTML="";
  if(!list||list.length===0){
    div.innerHTML="<div class='row'>No hay registros este mes.</div>";
    return;
  }
  list.forEach(r=>{
    const el=document.createElement("div");
    el.className="row";
    el.innerHTML=`<b>${r.fecha}</b> - ${r.usuario}<small>Hermanos:${r.hermanos}, Hermanas:${r.hermanas}, Amigos:${r.amigos}, Adolescentes:${r.adolescentes}, Ni√±os:${r.ni√±os}</small>`;
    div.appendChild(el);
  });
}
function mesSeleccionado(){ cargarMes(document.getElementById("selectMes").value); }
function refrescarMes(){ mesSeleccionado(); }

/* === ELIMINAR ASISTENCIA === */
function eliminarAsistencia(){
  mostrarPopupConfirm("Eliminar registros","¬øDeseas borrar todos los registros del mes?",async ()=>{
    try{
      const res=await fetch(`${URL_SCRIPT}?accion=eliminar`);
      const json=await res.json();
      if(json.ok) mostrarPopupAlerta("‚úÖ √âxito","Registros eliminados.");
      else mostrarPopupAlerta("‚ö†Ô∏è Error",json.msg||"Error al eliminar.");
    }catch(e){
      mostrarPopupAlerta("‚ö†Ô∏è Error","No se pudo conectar con el servidor.");
    }
  });
}

/* === POPUP CONFIRM === */
function mostrarPopupConfirm(titulo, mensaje, onConfirm){
  const p=document.getElementById("popupConfirm");
  document.getElementById("popupConfirmTitle").textContent=titulo;
  document.getElementById("popupConfirmMsg").textContent=mensaje;
  p.style.display="flex";
  const yes=document.getElementById("popupConfirmYes");
  const no=document.getElementById("popupConfirmNo");
  const cerrar=()=>p.style.display="none";
  yes.onclick=()=>{ cerrar(); if(onConfirm) onConfirm(); }
  no.onclick=()=>cerrar();
}
</script>
</body>
</html>
