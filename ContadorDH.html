<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asistencia Célula</title>
<style>
  body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background: #f4f6fb;
    color: #333;
    height: 100vh;
    overflow: hidden;
  }

  header {
    background: #0066ff;
    color: white;
    text-align: center;
    padding: 1rem;
    font-size: 1.4rem;
    font-weight: 600;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  header button {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
  }

  main {
    height: calc(100vh - 64px);
    padding: 1rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow-y: auto;
    transition: all 0.3s ease;
  }

  .counter {
    width: 90%;
    max-width: 400px;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.8rem;
  }

  .counter h3 { margin: 0; font-size: 1.1rem; }
  .controls { display: flex; align-items: center; gap: 0.5rem; }

  button {
    border: none;
    background: #0066ff;
    color: white;
    font-size: 1.3rem;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    transition: 0.2s;
  }

  button:hover { background: #004ecc; }

  .value {
    width: 40px;
    text-align: center;
    font-weight: 600;
    font-size: 1.1rem;
  }

  .total {
    background: #fff;
    padding: 1rem;
    width: 90%;
    max-width: 400px;
    border-radius: 16px;
    text-align: center;
    font-size: 1.3rem;
    font-weight: 600;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    margin-top: 0.5rem;
  }

  /* Menú lateral */
  #menuOverlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.3);
    display: none;
    z-index: 99;
  }

  #menu {
    position: fixed;
    top: 0;
    left: -260px;
    width: 240px;
    height: 100%;
    background: #fff;
    box-shadow: 4px 0 8px rgba(0,0,0,0.2);
    transition: 0.3s;
    z-index: 100;
    display: flex;
    flex-direction: column;
    padding-top: 2rem;
  }

  #menu.active { left: 0; }
  #menuOverlay.active { display: block; }

  #menu button {
    background: none;
    color: #333;
    font-size: 1.1rem;
    text-align: left;
    border: none;
    border-bottom: 1px solid #eee;
    width: 100%;
    padding: 1rem 1.5rem;
  }

  #menu button:hover {
    background: #0066ff;
    color: white;
  }

  /* Pantalla ver asistencia */
  #verPantalla {
    position: absolute;
    inset: 0;
    background: #f4f6fb;
    display: none;
    flex-direction: column;
    align-items: center;
    overflow-y: auto;
    z-index: 50;
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.4s ease;
  }

  #verPantalla.active {
    display: flex;
    opacity: 1;
    transform: translateX(0);
  }

  #verHeader {
    width: 100%;
    background: #0066ff;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    font-size: 1.2rem;
  }

  #verHeader button {
    background: none;
    border: none;
    color: white;
    font-size: 1.3rem;
    cursor: pointer;
  }

  #listado {
    width: 90%;
    max-width: 400px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    padding: 0.8rem;
    margin-top: 1rem;
    font-size: 0.9rem;
  }

</style>
</head>
<body>

<header>
  <button onclick="toggleMenu()">☰</button>
  <span>📋 Asistencia Célula</span>
  <span style="width:24px;"></span>
</header>

<!-- Fondo clickeable para cerrar menú -->
<div id="menuOverlay" onclick="toggleMenu()"></div>

<!-- Menú lateral -->
<div id="menu">
  <button onclick="subirAsistencia()">📤 Subir asistencia</button>
  <button onclick="abrirVerPantalla()">👁️ Ver asistencia</button>
  <button onclick="eliminarAsistencia()">🗑️ Eliminar registros</button>
</div>

<!-- Pantalla principal -->
<main id="principal">
  <div class="counter"><h3>Hermanos</h3>
    <div class="controls">
      <button onclick="changeCount('hermanos', -1)">−</button>
      <span id="hermanos" class="value">0</span>
      <button onclick="changeCount('hermanos', 1)">+</button>
    </div>
  </div>
  <div class="counter"><h3>Hermanas</h3>
    <div class="controls">
      <button onclick="changeCount('hermanas', -1)">−</button>
      <span id="hermanas" class="value">0</span>
      <button onclick="changeCount('hermanas', 1)">+</button>
    </div>
  </div>
  <div class="counter"><h3>Amigos</h3>
    <div class="controls">
      <button onclick="changeCount('amigos', -1)">−</button>
      <span id="amigos" class="value">0</span>
      <button onclick="changeCount('amigos', 1)">+</button>
    </div>
  </div>
  <div class="counter"><h3>Adolescentes</h3>
    <div class="controls">
      <button onclick="changeCount('adolescentes', -1)">−</button>
      <span id="adolescentes" class="value">0</span>
      <button onclick="changeCount('adolescentes', 1)">+</button>
    </div>
  </div>
  <div class="counter"><h3>Niños</h3>
    <div class="controls">
      <button onclick="changeCount('niños', -1)">−</button>
      <span id="niños" class="value">0</span>
      <button onclick="changeCount('niños', 1)">+</button>
    </div>
  </div>
  <div class="total">Total asistencia: <span id="total">0</span></div>
</main>

<!-- Pantalla Ver -->
<div id="verPantalla">
  <div id="verHeader">
    <button onclick="cerrarVerPantalla()">←</button>
    <span id="tituloMes">Asistencia</span>
    <button onclick="buscarNuevoMes()">🔍</button>
  </div>
  <div id="listado"></div>
</div>

<script>
const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbwuad6LbOg5k2TFzphjhPTm-NwMJwURzhfFPsEb8a5oB9KXuXIhWxe5QzrR2xLnDjYVlA/exec";
const datos = { hermanos: 0, hermanas: 0, amigos: 0, adolescentes: 0, niños: 0 };
let mesActual = "";

function toggleMenu() {
  document.getElementById('menu').classList.toggle('active');
  document.getElementById('menuOverlay').classList.toggle('active');
}

function changeCount(tipo, delta) {
  datos[tipo] = Math.max(0, datos[tipo] + delta);
  document.getElementById(tipo).textContent = datos[tipo];
  actualizarTotal();
}

function actualizarTotal() {
  const total = Object.values(datos).reduce((a, b) => a + b, 0);
  document.getElementById("total").textContent = total;
}

async function subirAsistencia() {
  toggleMenu();
  const total = Object.values(datos).reduce((a,b)=>a+b,0);
  if (total === 0) return alert("❗ No hay personas registradas.");
  const usuario = prompt("👤 Ingresa tu nombre:");
  if (!usuario) return alert("❗ Debes ingresar un nombre.");
  const fecha = new Date().toLocaleString("es-CO", {
    day: "2-digit", month: "2-digit", year: "numeric",
    hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: true
  });
  const params = new URLSearchParams({
    usuario, fecha,
    hermanos: datos.hermanos, hermanas: datos.hermanas,
    amigos: datos.amigos, adolescentes: datos.adolescentes,
    niños: datos.niños,
    total
  });
  try {
    const res = await fetch(`${URL_SCRIPT}?${params.toString()}`);
    const text = await res.text();
    alert(text.includes("OK") ? "✅ Asistencia registrada." : "⚠️ No se pudo registrar.\n" + text);
  } catch {
    alert("⚠️ Error de conexión con el servidor.");
  }
}

function abrirVerPantalla() {
  toggleMenu();
  document.getElementById("verPantalla").classList.add("active");
  buscarNuevoMes();
}

function cerrarVerPantalla() {
  const pantalla = document.getElementById("verPantalla");
  pantalla.classList.remove("active");
  setTimeout(()=> pantalla.style.display = "none", 400);
}

async function buscarNuevoMes() {
  const mes = prompt("📅 Ingresa el nombre del mes (Ej: Octubre):", mesActual || "");
  if (!mes) return;
  mesActual = mes;
  document.getElementById("tituloMes").textContent = "Asistencia de: " + mes;
  await verAsistencia(mes);
}

async function verAsistencia(mes) {
  try {
    const res = await fetch(`${URL_SCRIPT}?accion=listar&mes=${encodeURIComponent(mes)}`);
    const data = await res.json();
    const lista = document.getElementById("listado");
    if (data.length <= 1) {
      lista.innerHTML = "<p>⚠️ No hay registros en ese mes.</p>";
      return;
    }
    lista.innerHTML = data.slice(1).map(r =>
      `👤 ${r[0]}<br>📅 ${r[1]}<br>🙋‍♂️ ${r[2]} 🙋‍♀️ ${r[3]} 🤝 ${r[4]} 👧 ${r[5]} 🧒 ${r[6]}<br>🔢 Total: ${r[7]}<hr>`
    ).join("");
  } catch {
    alert("⚠️ No se pudo obtener la asistencia.");
  }
}

async function eliminarAsistencia() {
  toggleMenu();
  if (!confirm("⚠️ ¿Eliminar asistencias de los últimos 10 minutos?")) return;
  try {
    const res = await fetch(`${URL_SCRIPT}?accion=eliminar`);
    const text = await res.text();
    alert(text.includes("ELIMINADAS") ? "🗑️ Asistencias eliminadas." : "⚠️ No se eliminaron registros recientes.");
  } catch {
    alert("⚠️ Error de conexión al eliminar.");
  }
}
</script>
</body>
</html>
